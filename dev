#!/bin/bash
#
# Nodus ADK DEVSTACK - Development Environment Manager
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

PROJECT_NAME="nodus-adk"

function info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

function warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

function error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

function title() {
    echo -e "\n${BLUE}===${NC} $1 ${BLUE}===${NC}\n"
}

function check_env() {
    if [ ! -f ".env" ]; then
        warn ".env file not found"
        if [ -f ".env.example" ]; then
            info "Copying .env.example to .env"
            cp .env.example .env
            info "Please review and update .env with your configuration"
        fi
    fi
}

function cmd_up() {
    title "Starting Nodus ADK DEVSTACK"
    check_env
    docker compose up -d "$@"
    info "DEVSTACK started successfully"
    echo ""
    info "Services:"
    echo "  - Backoffice:   http://localhost:5001"
    echo "  - Llibreta:     http://localhost:5002"
    echo "  - ADK Runtime:  http://localhost:8080"
    echo "  - MCP Gateway:  http://localhost:7443"
    echo "  - Qdrant:       http://localhost:6333"
    echo "  - MinIO Console: http://localhost:9001"
    echo ""
    info "Run './dev logs' to view logs"
    info "Run './dev status' to check service health"
}

function cmd_down() {
    title "Stopping Nodus ADK DEVSTACK"
    docker compose down "$@"
    info "DEVSTACK stopped"
}

function cmd_restart() {
    title "Restarting service(s)"
    if [ -z "$1" ]; then
        docker compose restart
        info "All services restarted"
    else
        docker compose restart "$@"
        info "Service(s) restarted: $@"
    fi
}

function cmd_logs() {
    if [ -z "$1" ]; then
        docker compose logs -f --tail=100
    else
        docker compose logs -f --tail=100 "$@"
    fi
}

function cmd_status() {
    title "Service Status"
    docker compose ps
}

function cmd_shell() {
    if [ -z "$1" ]; then
        error "Usage: ./dev shell <service>"
    fi
    info "Opening shell in $1..."
    docker compose exec "$1" /bin/sh || docker compose exec "$1" /bin/bash
}

function cmd_clean() {
    title "Cleaning DEVSTACK"
    warn "This will remove all volumes and data. Are you sure? (y/N)"
    read -r response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        docker compose down -v
        info "Volumes cleaned"
    else
        info "Cancelled"
    fi
}

function cmd_rebuild() {
    title "Rebuilding service(s)"
    if [ -z "$1" ]; then
        docker compose build --no-cache
        info "All services rebuilt"
    else
        docker compose build --no-cache "$@"
        info "Service(s) rebuilt: $@"
    fi
}

function cmd_ps() {
    docker compose ps "$@"
}

function cmd_exec() {
    if [ -z "$1" ]; then
        error "Usage: ./dev exec <service> <command>"
    fi
    service="$1"
    shift
    docker compose exec "$service" "$@"
}

function cmd_help() {
    cat << EOF
Nodus ADK DEVSTACK - Development Environment Manager

Usage: ./dev <command> [options]

Commands:
  up [service]        Start all services or specific service
  down [-v]           Stop all services (-v to remove volumes)
  restart [service]   Restart all services or specific service
  logs [service]      View logs (all or specific service)
  status              Show service status
  ps                  List running containers
  shell <service>     Open shell in service container
  exec <service> cmd  Execute command in service container
  rebuild [service]   Rebuild images (all or specific)
  clean               Remove all volumes and data
  help                Show this help message

Examples:
  ./dev up                    # Start all services
  ./dev up adk-runtime        # Start only ADK runtime
  ./dev logs llibreta         # View llibreta logs
  ./dev shell backoffice      # Shell into backoffice
  ./dev restart mcp-gateway   # Restart MCP gateway
  ./dev rebuild adk-runtime   # Rebuild ADK runtime image

Services:
  - postgres          PostgreSQL database
  - redis             Redis cache/queue
  - qdrant            Vector database
  - minio             S3-compatible storage
  - backoffice        Nodus control plane
  - llibreta          Nodus UI
  - mcp-gateway       MCP integration layer
  - adk-runtime       Google ADK runtime

EOF
}

# Main command router
case "$1" in
    up)
        shift
        cmd_up "$@"
        ;;
    down)
        shift
        cmd_down "$@"
        ;;
    restart)
        shift
        cmd_restart "$@"
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    status)
        cmd_status
        ;;
    ps)
        shift
        cmd_ps "$@"
        ;;
    shell)
        shift
        cmd_shell "$@"
        ;;
    exec)
        shift
        cmd_exec "$@"
        ;;
    rebuild)
        shift
        cmd_rebuild "$@"
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        if [ -z "$1" ]; then
            cmd_help
        else
            error "Unknown command: $1. Run './dev help' for usage."
        fi
        ;;
esac


