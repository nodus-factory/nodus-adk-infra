version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: nodus-adk-postgres
    environment:
      POSTGRES_USER: nodus
      POSTGRES_PASSWORD: nodus_dev_password
      POSTGRES_DB: nodus
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgres:/docker-entrypoint-initdb.d
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nodus"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: nodus-adk-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: nodus-adk-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  minio:
    image: minio/minio:latest
    container_name: nodus-adk-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ============================================================================
  # Nodus OS Services (from cloned repos)
  # ============================================================================

  backoffice:
    build:
      context: ../nodus-backoffice
      dockerfile: Dockerfile
    container_name: nodus-adk-backoffice
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      NODE_ENV: development
      PORT: 5001
      JWT_JWKS_URL: http://localhost:5001/.well-known/jwks.json
      JWT_ISSUER: backoffice
      JWT_AUDIENCE: backoffice
    ports:
      - "5001:5001"
    volumes:
      - ../nodus-backoffice:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    user: root
    entrypoint: []
    command: sh -c "npm install && npm run dev"

  llibreta:
    build:
      context: ../nodus-llibreta
      dockerfile: Dockerfile
    container_name: nodus-adk-llibreta
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      AUTH_DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      ADK_RUNTIME_URL: http://adk-runtime:8080
      PERSONAL_ASSISTANT_ENGINE: ${PERSONAL_ASSISTANT_ENGINE:-graph}
      NODE_ENV: development
      PORT: 5002
    ports:
      - "5002:5002"
    volumes:
      - ../nodus-llibreta:/app
      - llibreta_node_modules:/app/node_modules
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started
    user: "0:0"
    command: sh -c "chown -R 1000:1000 /app/node_modules 2>/dev/null || true && chown -R 1000:1000 /app 2>/dev/null || true && su node -c 'cd /app && npm install --include=dev && npm run dev:simple'"

  mcp-gateway:
    build:
      context: ../nodus-mcp-gateway
      dockerfile: Dockerfile
    container_name: nodus-adk-mcp-gateway
    environment:
      PORT: 7443
      REDIS_URL: redis://redis:6379/1
      BACKOFFICE_URL: http://backoffice:5001
      LOG_LEVEL: debug
    ports:
      - "7443:7443"
    volumes:
      - ../nodus-mcp-gateway:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
    depends_on:
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started
    command: sh -c "npm install --include=dev && npm run dev"

  # ============================================================================
  # ADK Services (from new repos)
  # ============================================================================

  adk-web:
    build:
      context: ../nodus-adk-agents
      dockerfile: Dockerfile.dev
    container_name: nodus-adk-web
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      MCP_GATEWAY_URL: http://mcp-gateway:7443
      QDRANT_URL: http://qdrant:6333
      LOG_LEVEL: INFO
      PORT: 8000
    ports:
      - "8000:8000"
    volumes:
      - ../nodus-adk-agents:/app
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started
      mcp-gateway:
        condition: service_started

  adk-runtime:
    build:
      context: ../nodus-adk-runtime
      dockerfile: Dockerfile.dev
    container_name: nodus-adk-runtime
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      MCP_GATEWAY_URL: http://mcp-gateway:7443
      QDRANT_URL: http://qdrant:6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      ADK_MODEL: ${ADK_MODEL:-gemini-2.0-flash-exp}
      ADK_PROJECT_ID: ${ADK_PROJECT_ID:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      PORT: 8080
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5002,http://localhost:5001}
    ports:
      - "8080:8080"
    volumes:
      - ../nodus-adk-runtime/src:/app/src
      - ../nodus-adk-agents:/nodus-adk-agents
    networks:
      - nodus-adk-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      backoffice:
        condition: service_started
      mcp-gateway:
        condition: service_started

# ============================================================================
# Networks
# ============================================================================

networks:
  nodus-adk-internal:
    name: nodus-adk-internal
    driver: bridge
  nodus-adk-edge:
    name: nodus-adk-edge
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================

volumes:
  postgres_data:
    name: nodus-adk-postgres-data
  redis_data:
    name: nodus-adk-redis-data
  qdrant_data:
    name: nodus-adk-qdrant-data
  minio_data:
    name: nodus-adk-minio-data
  llibreta_node_modules:
    name: nodus-adk-llibreta-node-modules

