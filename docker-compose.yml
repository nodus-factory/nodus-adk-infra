version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: nodus-adk-postgres
    environment:
      POSTGRES_USER: nodus
      POSTGRES_PASSWORD: nodus_dev_password
      POSTGRES_DB: nodus
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/postgres:/docker-entrypoint-initdb.d
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nodus"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: nodus-adk-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: nodus-adk-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  minio:
    image: minio/minio:latest
    container_name: nodus-adk-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./data/minio:/data
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ============================================================================
  # Observability: Langfuse (LLM Tracing & Observability)
  # ============================================================================

  langfuse:
    image: langfuse/langfuse:2
    container_name: nodus-adk-langfuse
    restart: unless-stopped
    environment:
      # PostgreSQL connection
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/langfuse_db
      
      # NextAuth configuration
      NEXTAUTH_SECRET: ${LANGFUSE_SECRET_KEY:-langfuse_dev_secret_change_in_production}
      SALT: ${LANGFUSE_SECRET_KEY:-langfuse_dev_secret_change_in_production}
      NEXTAUTH_URL: http://localhost:3000
      
      # Disable telemetry
      TELEMETRY_ENABLED: false
      
      # Enable experimental features (prompt management, etc.)
      LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: true
      
      # Server configuration
      HOSTNAME: 0.0.0.0
      PORT: 3000
      
    ports:
      - "3000:3000"
    
    volumes:
      - ./data/langfuse:/app/uploads
    
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    
    depends_on:
      postgres:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/api/public/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "3"

  # ============================================================================
  # OpenMemory (Memory Layer - MCP Server via nodus-memory fork)
  # ============================================================================

  openmemory:
    image: ghcr.io/nodus-factory/openmemory:stable
    container_name: nodus-adk-openmemory
    ports:
      - "8088:8080"
    environment:
      # Core Configuration
      OM_PORT: 8080
      OM_MODE: standard
      OM_TIER: hybrid
      
      # Database Backend (PostgreSQL)
      OM_METADATA_BACKEND: postgresql
      OM_PG_HOST: postgres
      OM_PG_PORT: 5432
      OM_PG_DB: openmemory
      OM_PG_USER: nodus
      OM_PG_PASSWORD: nodus_dev_password
      OM_PG_SCHEMA: public
      OM_PG_TABLE: openmemory_memories
      OM_PG_SSL: disable
      
      # Vector Backend (SQLite for simplicity)
      OM_VECTOR_BACKEND: sqlite
      OM_VECTOR_TABLE: openmemory_vectors
      
      # Embeddings via LiteLLM
      OM_EMBEDDINGS: openai
      OM_OPENAI_API_KEY: sk-nodus-master-key
      OM_OPENAI_BASE_URL: http://litellm:4000/v1
      OM_OPENAI_MODEL: text-embedding-3-small
      
      # Memory Features
      OM_DECAY_REINFORCE_ON_QUERY: "true"
      OM_DECAY_INTERVAL_MINUTES: 1440  # Daily decay
      OM_AUTO_REFLECT: "true"
      OM_REFLECT_INTERVAL: 10
      OM_USER_SUMMARY_INTERVAL: 30
      
      # HSG Configuration
      OM_MIN_SCORE: 0.3
      OM_MAX_PAYLOAD_SIZE: 1000000
      
      # LangGraph Integration
      OM_LG_NAMESPACE: nodus-adk
      OM_LG_MAX_CONTEXT: 50
      OM_LG_REFLECTIVE: "true"
      
    volumes:
      - ./data/openmemory:/data
    networks:
      - nodus-adk-internal
    depends_on:
      postgres:
        condition: service_healthy
      litellm:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Nodus OS Services (from cloned repos)
  # ============================================================================

  backoffice:
    build:
      context: ../nodus-backoffice
      dockerfile: Dockerfile
    container_name: nodus-adk-backoffice
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      QDRANT_URL: http://qdrant:6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      NODE_ENV: development
      PORT: 5001
      JWT_JWKS_URL: http://localhost:5001/.well-known/jwks.json
      JWT_ISSUER: backoffice
      JWT_AUDIENCE: backoffice
    ports:
      - "5001:5001"
    volumes:
      - ../nodus-backoffice:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    user: root
    entrypoint: []
    command: sh -c "npm install && npm run dev"

  llibreta:
    build:
      context: ../nodus-llibreta
      dockerfile: Dockerfile
    container_name: nodus-adk-llibreta
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      AUTH_DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      ADK_RUNTIME_URL: http://adk-runtime:8080
      PERSONAL_ASSISTANT_ENGINE: ${PERSONAL_ASSISTANT_ENGINE:-graph}
      NODE_ENV: development
      PORT: 5002
    ports:
      - "5002:5002"
    volumes:
      - ../nodus-llibreta:/app
      - llibreta_node_modules:/app/node_modules
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started
    user: "0:0"
    command: sh -c "chown -R 1000:1000 /app/node_modules 2>/dev/null || true && chown -R 1000:1000 /app 2>/dev/null || true && su node -c 'cd /app && npm install --include=dev && npm run dev:simple'"

  mcp-gateway:
    build:
      context: ../nodus-mcp-gateway
      dockerfile: Dockerfile
    container_name: nodus-adk-mcp-gateway
    environment:
      PORT: 7443
      REDIS_URL: redis://redis:6379/1
      BACKOFFICE_URL: http://backoffice:5001
      LOG_LEVEL: debug
    ports:
      - "7443:7443"
    volumes:
      - ../nodus-mcp-gateway:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
    depends_on:
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started
    command: sh -c "npm install --include=dev && npm run dev"

  # ============================================================================
  # AI Gateway (LiteLLM Self-Hosted)
  # ============================================================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: nodus-adk-litellm
    ports:
      - "4000:4000"
    volumes:
      - ./config/litellm:/app/config
    command: [ "--config", "/app/config/litellm_config.yaml", "--port", "4000", "--detailed_debug" ]
    environment:
      - DATABASE_URL=postgresql://nodus:nodus_dev_password@postgres:5432/litellm_db
      - STORE_MODEL_IN_DB=True
      
      # Provider API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GOOGLE_API_KEY:-}
      
      # Master Key (used for API auth and Admin UI login)
      # Admin UI: username=admin, password=LITELLM_MASTER_KEY
      - LITELLM_MASTER_KEY=sk-nodus-master-key
      
      # Langfuse integration for observability
      - LANGFUSE_PUBLIC_KEY=pk-lf-a401fb0c-6ee3-4636-afd4-803b9dfe4aaf
      - LANGFUSE_SECRET_KEY=sk-lf-ccb62e83-9148-49f8-8858-ff3c963bb7a8
      - LANGFUSE_HOST=http://langfuse:3000
    networks:
      - nodus-adk-internal
    depends_on:
      - postgres
      - redis
      - langfuse

  # ============================================================================
  # ADK Services (from new repos)
  # ============================================================================

  agent-pool:
    build:
      context: ../nodus-adk-agents
      dockerfile: Dockerfile.pool
    container_name: nodus-adk-agent-pool
    environment:
      LOG_LEVEL: INFO
      PORT: 8000
      
      # Langfuse observability for A2A agents
      LANGFUSE_ENABLED: ${LANGFUSE_ENABLED:-true}
      LANGFUSE_HOST: http://langfuse:3000
      LANGFUSE_PUBLIC_KEY: pk-lf-a401fb0c-6ee3-4636-afd4-803b9dfe4aaf
      LANGFUSE_SECRET_KEY: sk-lf-ccb62e83-9148-49f8-8858-ff3c963bb7a8
      
      # OpenTelemetry configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://langfuse:3000/api/public/ingestion}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME_A2A:-nodus-adk-agent-pool}
      OTEL_TRACES_SAMPLER: ${OTEL_TRACES_SAMPLER:-parentbased_traceidratio}
      OTEL_TRACES_SAMPLER_ARG: ${OTEL_TRACES_SAMPLER_ARG:-1.0}
    ports:
      - "8000:8000"
    networks:
      - nodus-adk-internal
    depends_on:
      langfuse:
        condition: service_healthy

  adk-runtime:
    build:
      context: ../nodus-adk-runtime
      dockerfile: Dockerfile.dev
    container_name: nodus-adk-runtime
    environment:
      # Database & Services
      DATABASE_URL: postgresql+asyncpg://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      MCP_GATEWAY_URL: http://mcp-gateway:7443
      QDRANT_URL: http://qdrant:6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      
      # AI Models (via LiteLLM proxy)
      # Using Gemini model recognized by ADK, but LiteLLM routes it
      ADK_MODEL: ${ADK_MODEL:-gemini-2.0-flash-exp}
      ADK_PROJECT_ID: ${ADK_PROJECT_ID:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}  # Not used - routed via LiteLLM
      
      # Server Config
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      PORT: 8080
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5002,http://localhost:5001,http://localhost:3000}
      
      # Langfuse Observability
      LANGFUSE_ENABLED: ${LANGFUSE_ENABLED:-true}
      LANGFUSE_HOST: http://langfuse:3000
      LANGFUSE_PUBLIC_KEY: pk-lf-a401fb0c-6ee3-4636-afd4-803b9dfe4aaf
      LANGFUSE_SECRET_KEY: sk-lf-ccb62e83-9148-49f8-8858-ff3c963bb7a8
      LANGFUSE_SDK_INTEGRATION: nodus-adk
      
      # LiteLLM Proxy Configuration (unified AI gateway for ALL models)
      # ALL LLM calls (OpenAI, Gemini, Claude) go through this proxy
      OPENAI_API_BASE: http://litellm:4000/v1
      OPENAI_API_KEY: sk-nodus-master-key
      LITELLM_PROXY_API_BASE: http://litellm:4000
      LITELLM_PROXY_API_KEY: sk-nodus-master-key
      
      # OpenTelemetry Configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://langfuse:3000/api/public/ingestion}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-nodus-adk-runtime}
      OTEL_TRACES_SAMPLER: ${OTEL_TRACES_SAMPLER:-parentbased_traceidratio}
      OTEL_TRACES_SAMPLER_ARG: ${OTEL_TRACES_SAMPLER_ARG:-1.0}
      
      # ADK Telemetry
      ADK_CAPTURE_MESSAGE_CONTENT_IN_SPANS: ${ADK_CAPTURE_MESSAGE_CONTENT_IN_SPANS:-true}
      
    ports:
      - "8080:8080"
    volumes:
      - ../nodus-adk-runtime/src:/app/src
      - ../nodus-adk-agents:/nodus-adk-agents
    networks:
      - nodus-adk-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      backoffice:
        condition: service_started
      mcp-gateway:
        condition: service_started
      langfuse:
        condition: service_healthy

# ============================================================================
# Networks
# ============================================================================

networks:
  nodus-adk-internal:
    name: nodus-adk-internal
    driver: bridge
  nodus-adk-edge:
    name: nodus-adk-edge
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
# Note: Critical data volumes (postgres, redis, qdrant, minio, langfuse) use
# host bind mounts at ./data/* to ensure:
# 1. Data persists across container rebuilds/removals
# 2. Data is backed up by Time Machine (macOS) automatically
# 3. Data can be version controlled (if desired) or manually backed up
# 4. Compatible with Hetzner staging/prod backups

volumes:
  # Ephemeral volumes only
  llibreta_node_modules:
    name: nodus-adk-llibreta-node-modules


