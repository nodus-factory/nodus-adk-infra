version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: nodus-adk-postgres
    environment:
      POSTGRES_USER: nodus
      POSTGRES_PASSWORD: nodus_dev_password
      POSTGRES_DB: nodus
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./config/postgres:/docker-entrypoint-initdb.d
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nodus"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: nodus-adk-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: nodus-adk-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio:
    image: minio/minio:latest
    container_name: nodus-adk-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - nodus-adk-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ============================================================================
  # Nodus OS Services (from cloned repos)
  # ============================================================================

  backoffice:
    build:
      context: ../nodus-backoffice
      dockerfile: Dockerfile
    container_name: nodus-adk-backoffice
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      NODE_ENV: development
      PORT: 5001
    ports:
      - "5001:5001"
    volumes:
      - ../nodus-backoffice:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: npm run dev

  llibreta:
    build:
      context: ../nodus-llibreta
      dockerfile: Dockerfile
    container_name: nodus-adk-llibreta
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      ADK_RUNTIME_URL: http://adk-runtime:8080
      NODE_ENV: development
      PORT: 5002
    ports:
      - "5002:5002"
    volumes:
      - ../nodus-llibreta:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
      - nodus-adk-edge
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started
    command: npm run dev

  mcp-gateway:
    build:
      context: ../nodus-mcp-gateway
      dockerfile: Dockerfile
    container_name: nodus-adk-mcp-gateway
    environment:
      PORT: 7443
      REDIS_URL: redis://redis:6379/1
      BACKOFFICE_URL: http://backoffice:5001
      LOG_LEVEL: debug
    ports:
      - "7443:7443"
    volumes:
      - ../nodus-mcp-gateway:/app
      - /app/node_modules
    networks:
      - nodus-adk-internal
    depends_on:
      redis:
        condition: service_healthy
      backoffice:
        condition: service_started

  # ============================================================================
  # ADK Services (from new repos)
  # ============================================================================

  adk-runtime:
    build:
      context: ../nodus-adk-runtime
      dockerfile: Dockerfile.dev
    container_name: nodus-adk-runtime
    environment:
      DATABASE_URL: postgresql://nodus:nodus_dev_password@postgres:5432/nodus
      REDIS_URL: redis://redis:6379/0
      BACKOFFICE_URL: http://backoffice:5001
      MCP_GATEWAY_URL: http://mcp-gateway:7443
      QDRANT_URL: http://qdrant:6333
      ADK_MODEL: gemini-2.0-flash-exp
      LOG_LEVEL: DEBUG
      PORT: 8080
    ports:
      - "8080:8080"
    volumes:
      - ../nodus-adk-runtime/src:/app/src
    networks:
      - nodus-adk-internal
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      backoffice:
        condition: service_started
      mcp-gateway:
        condition: service_started

# ============================================================================
# Networks
# ============================================================================

networks:
  nodus-adk-internal:
    name: nodus-adk-internal
    driver: bridge
  nodus-adk-edge:
    name: nodus-adk-edge
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================

volumes:
  postgres_data:
    name: nodus-adk-postgres-data
  redis_data:
    name: nodus-adk-redis-data
  qdrant_data:
    name: nodus-adk-qdrant-data
  minio_data:
    name: nodus-adk-minio-data

